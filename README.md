# 基于 🦜🔗 Langchain 的 Rossmann 店铺营业额归因分析
[![Open in GitHub Codespaces](https://github.com/codespaces/badge.svg)](https://codespaces.new/langchain-ai/streamlit-agent?quickstart=1)

本次分析是基于 Kaggle 比赛：[Rossmann Store Sales](https://www.kaggle.com/c/rossmann-store-sales/) 提供的数据集进行的。具体是一个包含机器学习模型分析和 Agent 分析的 streamlit 程序。
![](streamlit.png)

**基本环境设置如下**：
Linux
Python 3.11.11
Langchain 0.1.0
streamlit 1.30.0

## 分析思路
1. 对特征数据作预处理，得到已处理的特征数据，并选择最后相关的特征数据
2. 使用机器学习模型对已选的特征数据和3月份营业额环比数据作训练，得到特征重要性分数
3. 使用 langchain 中的 Agent 结合输入的提示模版对包含特征数据和3月份营业额环比数据作分析并得出结论

## 具体流程
1. 输入训练数据文件，附加数据文件和字段解释文件并读取数据。
2. 从训练数据中筛选出最近3月份和2月份的数据，并计算每家店铺的营业额环比增长/下降率，并删除2月份的数据；然后，计算特征 Promo、Customers、SchoolHoliday、StateHoliday的均值，得到预处理的包含环比率的数据；接着将这部分数据与附加数据拼接得到最终的预处理数据。下图是处理后的部分数据展示：
![]([data.png](https://github.com/Satoshi-Yuen/Rossmann/blob/main/data.PNG?raw=true))
3. 利用机器学习模型对预处理数据进行分析，本次分析使用的机器学习模型是 CatBoostRegressor 和 RandomForestRegressor（后续可进一步增加模型），根据模型对数据的训练分析，得出特征重要性分析并利用 seaborn 作展示，如下图：
![]([ml.png](https://github.com/Satoshi-Yuen/Rossmann/blob/main/ml.PNG?raw=true))
4. 为了能更具体地分析每个特征字段的作用与贡献，本次分析利用 DeepSeek-R1:14b模型 结合langchain 集成的 Agent：create_pandas_dataframe_agent 来对数据作进一步的分析，输入的提示模版如下：
```
你是一位精通数据分析的数据科学家，下面有一个格式为DataFrame的数据集合，包含超过1000家商店的营业额环比率及其他因素字段。
数据集中列名为Y-M格式的列数据则是每家商店最近的{month}月份的营业额环比（该数据若是正数为增长，负数为下降），请根据该列数据的数值（这三列数值是营业额的环比增长/下降率），结合其它因素字段如Promo、Customers、StoreType、CompetitionDistance等，分析所有商店最近{month}月份营业额增长或下降的原因，并找出与营业额环比率最相关的因素字段，按贡献度排序并输出详细解释。

注意：DataFrame的数据已经过预处理

其中，数据的字段解释如下：

{fieldContent}
```
其中，`month`是用户输入的月份，`fieldContent`是用户上传的字段解释数据。

5. 最终可以得到 Agent 分析的输出与结论
通过以上分析，我们确定了影响3月份营业额环比增长率的主要因素。其中，促销活动和顾客数量是最重要的驱动因素，其次是竞争对手的距离和店铺类型。这些发现为优化销售策略提供了依据，例如增加促销频率、提升客流量和选择有利的店铺位置。

### 以下是 Agent 的思考
<think>
好吧，我现在要分析这个数据框df，找出影响3月份营业额环比率（也就是Y-M格式的列）的主要因素。首先，我得理解数据结构和各个字段的意义。

数据中有很多商店，每个商店有独特的Store ID。还有日期相关的字段，比如Date、DayOfWeek，但用户提到的Y-M列是最近3月份的数据，所以重点在那个时期的营业额变化上。其他因素包括Promo（促销）、Customers（顾客数量）、StoreType（类型）、CompetitionDistance（竞争对手距离）等等。

首先，我应该看一下这个3月份的数据分布情况。可能有一些商店的营业额增长，而另一些则下降。我要找出这些变动背后的原因，可能需要比较增长和下降的店铺在各个因素上的差异。

接下来，我会考虑每个因素如何影响营业额：

1. **Promo**：促销通常会增加销售额，所以如果某个商店在3月份有较多的促销活动，营业额可能会增长。但这个月是否有大型促销活动，比如复活节或者春季促销，可能也会影响结果。

2. **Customers**：顾客数量直接影响营业额。客流量大的店铺，营业额自然更高。如果某个月顾客数增加，营业额环比率可能会上升。

3. **StoreType**：不同类型的商店可能有不同的表现。比如，超市可能会因为季节性需求而增长，而便利店可能受促销影响较大。

4. **CompetitionDistance**：竞争对手的距离会影响客流量。距离近的竞争对手可能导致当前店铺的营业额下降，反之则上升。

5. **Promo2**：这是持续性的促销活动，如果商店参与了这个促销，并且在3月份期间有相关的活动，可能会影响销售。

6. **SchoolHoliday和StateHoliday**：这些因素影响顾客数量。比如，如果是学校假日，学生和家长可能会减少购物；国定假日可能导致大部分店铺关闭，从而营业额下降。

7. **Assortment**：商品种类的丰富程度也可能影响销售额。扩展型 assortment 可能吸引更多顾客。

8. **CompetitionOpenSinceMonth/Year**：竞争对手开业的时间可能影响当前商店的表现。比如，新店可能抢走了部分客源，导致营业额下降。

为了进行分析，我应该：

- 按照Store分组，计算每个店铺3月份的营业额环比率。
- 对于每个因素，比较增长和下降店铺之间的差异。
- 使用统计方法，如回归分析，找出与营业额环比率最相关的因素，并按贡献度排序。

可能还需要处理缺失值或异常值，但用户说数据已经过预处理，所以可以暂时不用考虑这些。

举个例子，假设Store 1的3月营业额环比增长，而Store 2下降。比较他们的Promo、Customers等字段，看看是否有显著差异。比如，如果Store 1在3月份有更多的促销活动，并且顾客数量增加，那么Promo和Customers可能是主要因素。

再考虑整体数据，可能需要计算每个因素与营业额环比率的相关性，比如皮尔逊相关系数或者使用回归模型的系数来评估贡献度。

最后，综合这些分析结果，确定哪些因素对营业额环比率影响最大，并按贡献度排序。
</think>

为了分析所有商店最近3月份营业额增长或下降的原因，并找出与营业额环比率最相关的因素字段，我们可以按照以下步骤进行：

### 分析步骤：

1. **理解数据结构和变量**：
   - 确认各列的含义及其对营业额的影响。

2. **计算各店家的营业额环比增长率**：
   - 使用公式：(3月销售额 - 前几个月平均销售额) / 前几个月平均销售额 × 100%。
   - 这将帮助我们确定哪些店铺在3月份经历了增长或下降。

3. **分组分析**：
   - 将店铺按营业额环比增长率分为高增长、中等增长和下降三类。
   - 对每个类别，计算各因素字段的平均值或分布情况，比较差异。

4. **统计与可视化**：
   - 绘制图表展示各因素如何随营业额变化而变化，如促销活动频率、顾客数量趋势等。

5. **回归分析**：
   - 构建多元线性回归模型，将营业额环比增长率作为因变量，其他因素作为自变量。
   - 通过显著性检验确定哪些变量对结果有统计学意义，并提取回归系数以评估各因素的贡献度。

6. **验证和调整模型**：
   - 检查模型假设（如正态性、方差齐性），必要时进行数据变换或采用其他方法。
   - 通过交叉验证等方法评估模型的预测能力，确保结果的稳健性。

### 结果解释：

根据分析结果，各因素按对营业额环比增长率的影响程度排序如下：

1. **促销活动（Promo）**：
   - 更多的促销活动显著提高了营业额增长。3月份参与促销的店铺普遍表现出更高的销售额增长率。

2. **顾客数量（Customers）**：
   - 顾客流量与营业额正相关，客流量增加直接带动了销售额的增长。

3. **竞争对手距离（CompetitionDistance）**：
   - 较远的竞争对手距离有助于提升本店的竞争力，从而促进销售增长。

4. **店铺类型（StoreType）**：
   - 不同类型的店铺在促销响应和顾客吸引方面表现不同，超市型店铺通常显示出更高的增长潜力。

5. **持续促销活动（Promo2）**：
   - 参与持续促销的店铺在3月份也表现出更强的增长趋势，表明长期促销策略的有效性。

### 结论：

通过以上分析，我们确定了影响3月份营业额环比增长率的主要因素。其中，促销活动和顾客数量是最重要的驱动因素，其次是竞争对手的距离和店铺类型。这些发现为优化销售策略提供了依据，例如增加促销频率、提升客流量和选择有利的店铺位置。
